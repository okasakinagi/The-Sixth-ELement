
# 数据库表结构（JSON 视图，便于对照 API）

本文档用于多人协作/迁移时快速对齐：

- API 期望的 JSON 结构（来自 `doc/api/*.md`）
- 数据库实际存储结构（来自 `core/models.py` / migrations）

约定：以下 JSON 为“结构示意/样例”，并非严格类型定义。

```json
{
	"collaboration_workflow": {
		"rule": "迁移文件原则上由 Django 生成，不手写",
		"steps": [
			"修改 core/models.py",
			"运行: python Main.py makemigrations",
			"运行: python Main.py migrate",
			"提交: core/migrations/*.py"
		],
		"note": "如果有人本地无法连上 MySQL（常见于 MySQL 8 + caching_sha2_password + 不兼容驱动），优先统一驱动方案（本项目已切到 PyMySQL）后再生成迁移。"
	}
}
```

---

## 用户（AppUser）

### API 期望 JSON（User 基础）

```json
{
	"id": "u_123",
	"nickname": "Alice",
	"school": "某大学",
	"tags": ["心理学", "产品"],
	"credit_score": 80,
	"points": 120,
	"activity_points": 56
}
```

### DB 存储 JSON（core_appuser）

```json
{
	"id": "u_123",
	"email": "alice@example.com",
	"password": "<string>",
	"nickname": "Alice",
	"school": "某大学",
	"tags": "心理学,产品",
	"credit_score": 80,
	"points": 120,
	"activity_points": 56,
	"token": "<bearer-token>",
	"created_at": "2026-01-21T00:00:00Z"
}
```

### 映射说明

```json
{
	"tags": {
		"api": "string[]",
		"db": "string (CSV)",
		"note": "当前后端允许 API 传数组并拼接为 CSV 存储；返回给前端时建议再 split 成数组。"
	}
}
```

---

## 问卷（Survey）

### API 期望 JSON（问卷管理列表项）

```json
{
	"id": "S-1204",
	"title": "城市通勤满意度问卷",
	"status": "draft",
	"completed": 0,
	"target": 120,
	"updated_at": "2026-01-12",
	"subtitle": "了解通勤体验与痛点",
	"created_at": "2026-01-10T12:00:00Z"
}
```

### API 期望 JSON（问卷制作草稿 SurveyDraft）

```json
{
	"id": "draft_001",
	"title": "员工餐厅就餐满意度调查",
	"subtitle": "本问卷用于了解员工对餐厅服务的满意度。",
	"prompt": "请生成一份调查问卷...",
	"status": "draft",
	"questions": [
		{
			"id": "q_1",
			"type": "single",
			"title": "您一周大约在员工餐厅就餐几次？",
			"options": ["1-2 次", "3-4 次", "5 次以上"],
			"required": true,
			"is_ai": true,
			"order": 1
		}
	],
	"updated_at": "2026-01-12T10:20:00Z"
}
```

### DB 存储 JSON（core_survey）

```json
{
	"id": "s_xxx",
	"owner_id": "u_123",
	"title": "城市通勤满意度问卷",
	"subtitle": "了解通勤体验与痛点",
	"description": null,
	"prompt": "请生成一份调查问卷...",
	"link": "https://example.com/forms/xxx",
	"reward_points": 5,
	"budget_points": 600,
	"deadline": "2026-02-01",
	"estimated_minutes": 8,
	"status": "draft",
	"completed": 0,
	"target": 120,
	"published_at": "2026-01-12T10:00:00Z",
	"created_at": "2026-01-10T12:00:00Z",
	"updated_at": "2026-01-12T10:20:00Z"
}
```

### 映射说明

```json
{
	"status": {
		"api_enum": ["draft", "live", "paused", "ended"],
		"db_current": "string",
		"note": "模型层已按 API 预留，但现有部分后端逻辑仍可能写入 active/closed；建议后端统一为 draft/live/paused/ended。"
	},
	"updated_at": {
		"api": "有的页面用 YYYY-MM-DD",
		"db": "datetime",
		"note": "返回给管理页时可格式化为日期字符串。"
	}
}
```

---

## 问卷问题（SurveyQuestion）

### API 期望 JSON（questions[]）

```json
{
	"id": "q_1",
	"type": "single",
	"title": "您一周大约在员工餐厅就餐几次？",
	"options": ["1-2 次", "3-4 次", "5 次以上"],
	"required": true,
	"is_ai": true,
	"order": 1
}
```

### DB 存储 JSON（core_surveyquestion）

```json
{
	"id": "q_xxx",
	"survey_id": "s_xxx",
	"type": "single",
	"title": "您一周大约在员工餐厅就餐几次？",
	"options": ["1-2 次", "3-4 次", "5 次以上"],
	"required": true,
	"is_ai": true,
	"order": 1,
	"created_at": "2026-01-12T10:20:00Z",
	"updated_at": "2026-01-12T10:22:00Z"
}
```

### 索引（用于查询性能）

```json
[
	{"name": "core_sq_svy_order_idx", "fields": ["survey_id", "order"]},
	{"name": "core_sq_svy_type_idx", "fields": ["survey_id", "type"]}
]
```

---

## 其他表（现有，结构略）

### 填写记录（FillRecord / core_fillrecord）

```json
{
	"id": "f_xxx",
	"survey_id": "s_xxx",
	"user_id": "u_123",
	"duration_seconds": 120,
	"status": "pending",
	"points_awarded": 0,
	"created_at": "2026-01-21T00:00:00Z"
}
```

### 积分流水（PointsLog / core_pointslog）

```json
{
	"id": "p_xxx",
	"user_id": "u_123",
	"delta": -10,
	"reason": "发布问卷消耗",
	"created_at": "2026-01-21T00:00:00Z"
}
```

### 举报（Report / core_report）

```json
{
	"id": "r_xxx",
	"reporter_id": "u_123",
	"target_type": "survey",
	"target_id": "s_xxx",
	"reason": "违规内容",
	"status": "pending",
	"created_at": "2026-01-21T00:00:00Z"
}
```

---

## 与 API 文档一致性检查（结论）

```json
{
	"match": {
		"SurveyQuestion.questions_item": ["id", "type", "title", "options", "required", "is_ai", "order"],
		"Survey.management_item": ["id", "title", "subtitle", "status", "completed", "target", "created_at", "updated_at"],
		"User.basic": ["id", "nickname", "school", "credit_score", "points", "activity_points"]
	},
	"differences": {
		"User.tags": {
			"api": "string[]",
			"db": "string (CSV)",
			"action": "建议在返回 JSON 时 split 成数组；或后续迁移为 JSONField。"
		},
		"Survey.status": {
			"api_enum": ["draft", "live", "paused", "ended"],
			"db": "varchar(32)",
			"action": "表结构已支持；需要业务逻辑统一写入上述枚举（避免 active/closed 混用）。"
		},
		"SurveyDraft": {
			"api": "独立资源 /surveys/drafts",
			"db": "当前未单独建 draft 表",
			"action": "当前实现倾向将草稿字段合并在 Survey 表内；若要严格按 API 拆分，可新增 SurveyDraft 表。"
		},
		"Survey.updated_at": {
			"api": "部分页面用 YYYY-MM-DD",
			"db": "datetime",
			"action": "序列化时按页面需要格式化。"
		}
	}
}
```

